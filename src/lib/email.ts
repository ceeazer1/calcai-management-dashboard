interface OrderItem { description: string; quantity: number; amount: number; }
interface OrderConfirmationParams { to: string; customerName: string; orderId: string; amount: number; currency: string; items: OrderItem[]; paymentMethod?: string; shippingMethod?: string; shippingAmount?: number; shippingCurrency?: string; }

const esc = (s: string) => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const fmt = (a: number, c: string) => new Intl.NumberFormat('en-US',{style:'currency',currency:c.toUpperCase()}).format(a/100);

export async function sendOrderConfirmationEmail(p: OrderConfirmationParams): Promise<void> {
  const k = process.env.RESEND_API_KEY; if(!k) return;
  const {to,customerName,orderId,amount,currency,items,paymentMethod,shippingMethod,shippingAmount,shippingCurrency} = p;
  const shortId = orderId.length > 20 ? orderId.slice(-12).toUpperCase() : orderId;

  let rows = items.map(i=>`<tr><td style="padding:14px 0;border-bottom:1px solid #e5e5e5;color:#1a1a1a;font-size:16px">${i.quantity}× ${esc(i.description)}</td><td align="right" style="padding:14px 0;border-bottom:1px solid #e5e5e5;color:#555;font-size:16px">${fmt(i.amount,currency)}</td></tr>`).join('');
  if(shippingMethod && shippingAmount) rows += `<tr><td style="padding:14px 0;border-bottom:1px solid #e5e5e5;color:#1a1a1a;font-size:16px">Shipping — ${esc(shippingMethod)}</td><td align="right" style="padding:14px 0;border-bottom:1px solid #e5e5e5;color:#555;font-size:16px">${fmt(shippingAmount,shippingCurrency||currency)}</td></tr>`;

  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="color-scheme" content="light dark"><style>@media(prefers-color-scheme:dark){body{background:#121212!important}.card{background:#1e1e1e!important}td,p,h1,div,b{color:#f0f0f0!important}.sub{color:#a0a0a0!important}.box{background:#2a2a2a!important;border-color:#404040!important}.line{background:#404040!important}}</style></head><body style="margin:0;padding:24px 12px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5"><table class="card" width="100%" style="max-width:580px;margin:0 auto;background:#fff;border-radius:16px;padding:28px" cellpadding="0" cellspacing="0"><tr><td align="center" style="padding-bottom:20px;border-bottom:1px solid #e5e5e5"><img src="https://www.calcai.cc/logo.png" width="100" style="display:block;margin-bottom:16px"><h1 style="margin:0;font-size:28px;font-weight:800;color:#1a1a1a">Order Confirmed</h1></td></tr><tr><td><table class="box" width="100%" style="background:#fafafa;border:1px solid #e5e5e5;border-radius:12px;margin:20px 0" cellpadding="16" cellspacing="0"><tr><td align="center"><div style="display:inline-block;width:28px;height:28px;background:#22c55e;border-radius:50%;color:#fff;font-size:14px;line-height:28px;text-align:center;font-weight:700">✓</div><span class="line" style="display:inline-block;width:40px;height:3px;background:linear-gradient(90deg,#22c55e,#d4d4d4);vertical-align:middle;margin:0 4px;border-radius:2px"></span><div class="box" style="display:inline-block;width:28px;height:28px;background:#e8e8e8;border:2px solid #d4d4d4;border-radius:50%;text-align:center;line-height:26px"><img src="https://img.icons8.com/ios-filled/16/888888/gear.png" width="14" style="vertical-align:middle"></div><span class="line" style="display:inline-block;width:40px;height:3px;background:#d4d4d4;vertical-align:middle;margin:0 4px;border-radius:2px"></span><div class="box" style="display:inline-block;width:28px;height:28px;background:#e8e8e8;border:2px solid #d4d4d4;border-radius:50%;text-align:center;line-height:26px"><img src="https://img.icons8.com/ios-filled/16/888888/delivery.png" width="14" style="vertical-align:middle"></div><span class="line" style="display:inline-block;width:40px;height:3px;background:#d4d4d4;vertical-align:middle;margin:0 4px;border-radius:2px"></span><div class="box" style="display:inline-block;width:28px;height:28px;background:#e8e8e8;border:2px solid #d4d4d4;border-radius:50%;text-align:center;line-height:26px"><img src="https://img.icons8.com/ios-filled/16/888888/home.png" width="14" style="vertical-align:middle"></div></td></tr></table></td></tr><tr><td><p style="margin:0 0 12px;font-size:20px;font-weight:700;color:#1a1a1a">Hi ${esc(customerName)},</p><p class="sub" style="margin:0 0 20px;font-size:16px;color:#555;line-height:1.5">Thank you for your order. We will start processing in 1-2 days.</p><div class="box" style="background:#fafafa;border:1px solid #e5e5e5;border-radius:10px;padding:14px;margin-bottom:18px"><div class="sub" style="font-size:11px;color:#888;text-transform:uppercase;font-weight:600">Order ID</div><div style="font-size:15px;font-family:ui-monospace,monospace;color:#1a1a1a;margin-top:4px">${esc(shortId)}</div></div>${paymentMethod?`<p class="sub" style="margin:0 0 18px;font-size:15px;color:#555"><b style="color:#1a1a1a">Payment:</b> ${esc(paymentMethod)}</p>`:''}<table width="100%" cellpadding="0" cellspacing="0" style="color:#1a1a1a">${rows}<tr><td style="padding:16px 0;font-weight:800;font-size:16px">Total</td><td align="right" style="padding:16px 0;font-weight:800;font-size:22px">${fmt(amount,currency)}</td></tr></table><div style="border-top:1px solid #e5e5e5;padding-top:18px;margin-top:12px;text-align:center"><a href="https://discord.gg/calcai" style="display:inline-block;margin:0 6px"><img src="https://img.icons8.com/ios-filled/24/888888/discord-logo.png" width="22"></a><a href="https://tiktok.com/@calc_ai" style="display:inline-block;margin:0 6px"><img src="https://img.icons8.com/ios-filled/24/888888/tiktok.png" width="22"></a><a href="https://instagram.com/calc.ai" style="display:inline-block;margin:0 6px"><img src="https://img.icons8.com/ios-filled/24/888888/instagram-new.png" width="22"></a><p class="sub" style="margin:12px 0 0;font-size:11px;color:#aaa"><a href="https://calcai.cc" style="color:#aaa;text-decoration:none">calcai.cc</a></p></div></td></tr></table></body></html>`;

  const text = `Order Confirmed\n\nHi ${customerName},\n\nOrder: ${shortId}\n${paymentMethod?`Payment: ${paymentMethod}\n`:''}\n${items.map(i=>`${i.quantity}x ${i.description}: ${fmt(i.amount,currency)}`).join('\n')}\n${shippingMethod?`Shipping: ${shippingMethod} ${fmt(shippingAmount!,shippingCurrency||currency)}\n`:''}\nTotal: ${fmt(amount,currency)}\n\ncalcai.cc`;

  await fetch('https://api.resend.com/emails',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k}`},body:JSON.stringify({from:`${process.env.ORDER_FROM_NAME||'CalcAI'} <${process.env.ORDER_FROM_EMAIL||'orders@calcai.cc'}>`,to:[to],subject:`Order Confirmed #${orderId.slice(-8).toUpperCase()}`,html,text})});
}
