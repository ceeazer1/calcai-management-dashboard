interface OrderItem { description: string; quantity: number; amount: number; }
interface OrderConfirmationParams { to: string; customerName: string; orderId: string; amount: number; currency: string; items: OrderItem[]; paymentMethod?: string; shippingMethod?: string; shippingAmount?: number; shippingCurrency?: string; }

const esc = (s: string) => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const fmt = (a: number, c: string) => new Intl.NumberFormat('en-US',{style:'currency',currency:c.toUpperCase()}).format(a/100);

export async function sendOrderConfirmationEmail(p: OrderConfirmationParams): Promise<void> {
  const k = process.env.RESEND_API_KEY; if(!k) return;
  const {to,customerName,orderId,amount,currency,items,paymentMethod,shippingMethod,shippingAmount,shippingCurrency} = p;
  const shortId = orderId.length > 20 ? orderId.slice(-12).toUpperCase() : orderId;

  let rows = items.map(i=>`<tr><td style="padding:8px 0;border-bottom:1px solid #ddd">${i.quantity}× ${esc(i.description)}</td><td align="right" style="padding:8px 0;border-bottom:1px solid #ddd">${fmt(i.amount,currency)}</td></tr>`).join('');
  if(shippingMethod && shippingAmount) rows += `<tr><td style="padding:8px 0;border-bottom:1px solid #ddd">Shipping — ${esc(shippingMethod)}</td><td align="right" style="padding:8px 0;border-bottom:1px solid #ddd">${fmt(shippingAmount,shippingCurrency||currency)}</td></tr>`;

  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="color-scheme" content="light dark"><style>@media(prefers-color-scheme:dark){body,table{background:#111!important}.card{background:#1a1a1a!important}td,p,h1,div{color:#eee!important}.sub{color:#aaa!important}.box{background:#222!important;border-color:#333!important}}</style></head><body style="margin:0;padding:20px;font-family:system-ui,sans-serif;background:#f5f5f5"><table class="card" width="100%" style="max-width:500px;margin:0 auto;background:#fff;border-radius:12px;padding:20px" cellpadding="0" cellspacing="0"><tr><td align="center"><img src="https://www.calcai.cc/logo.png" width="70" style="margin-bottom:10px"><h1 style="margin:0 0 15px;font-size:22px;color:#111">Order Confirmed</h1></td></tr><tr><td><table class="box" width="100%" style="background:#f5f5f5;border-radius:8px;margin-bottom:15px" cellpadding="10" cellspacing="0"><tr><td align="center"><div style="display:inline-block;width:22px;height:22px;background:#22c55e;border-radius:50%;color:#fff;font-size:11px;line-height:22px;text-align:center">✓</div><span style="display:inline-block;width:30px;height:2px;background:#22c55e;vertical-align:middle;margin:0 2px"></span><div style="display:inline-block;width:22px;height:22px;background:#ddd;border-radius:50%;text-align:center;line-height:22px"><img src="https://img.icons8.com/ios-filled/16/888888/gear.png" width="12" style="vertical-align:middle"></div><span style="display:inline-block;width:30px;height:2px;background:#ddd;vertical-align:middle;margin:0 2px"></span><div style="display:inline-block;width:22px;height:22px;background:#ddd;border-radius:50%;text-align:center;line-height:22px"><img src="https://img.icons8.com/ios-filled/16/888888/delivery.png" width="12" style="vertical-align:middle"></div><span style="display:inline-block;width:30px;height:2px;background:#ddd;vertical-align:middle;margin:0 2px"></span><div style="display:inline-block;width:22px;height:22px;background:#ddd;border-radius:50%;text-align:center;line-height:22px"><img src="https://img.icons8.com/ios-filled/16/888888/home.png" width="12" style="vertical-align:middle"></div></td></tr></table></td></tr><tr><td><p style="margin:0 0 10px;font-size:15px;font-weight:600;color:#111">Hi ${esc(customerName)},</p><p class="sub" style="margin:0 0 15px;font-size:13px;color:#555">Thank you for your order. Processing starts in 1-2 days.</p><div class="box" style="background:#f5f5f5;border-radius:6px;padding:10px;margin-bottom:12px"><div class="sub" style="font-size:9px;color:#888;text-transform:uppercase">Order</div><div style="font-size:12px;font-family:monospace;color:#111">${esc(shortId)}</div></div>${paymentMethod?`<p class="sub" style="margin:0 0 12px;font-size:12px;color:#555"><b style="color:#111">Payment:</b> ${esc(paymentMethod)}</p>`:''}<table width="100%" cellpadding="0" cellspacing="0" style="font-size:13px;color:#111">${rows}<tr><td style="padding:10px 0;font-weight:700">Total</td><td align="right" style="padding:10px 0;font-weight:700;font-size:16px">${fmt(amount,currency)}</td></tr></table><div style="border-top:1px solid #eee;padding-top:12px;margin-top:8px;text-align:center"><a href="https://discord.gg/calcai" style="display:inline-block;margin:0 4px"><img src="https://img.icons8.com/ios-filled/20/888888/discord-logo.png" width="18"></a><a href="https://tiktok.com/@calc_ai" style="display:inline-block;margin:0 4px"><img src="https://img.icons8.com/ios-filled/20/888888/tiktok.png" width="18"></a><a href="https://instagram.com/calc.ai" style="display:inline-block;margin:0 4px"><img src="https://img.icons8.com/ios-filled/20/888888/instagram-new.png" width="18"></a><p class="sub" style="margin:8px 0 0;font-size:9px;color:#aaa"><a href="https://calcai.cc" style="color:#aaa;text-decoration:none">calcai.cc</a></p></div></td></tr></table></body></html>`;

  const text = `Order Confirmed\n\nHi ${customerName},\n\nOrder: ${shortId}\n${paymentMethod?`Payment: ${paymentMethod}\n`:''}\n${items.map(i=>`${i.quantity}x ${i.description}: ${fmt(i.amount,currency)}`).join('\n')}\n${shippingMethod?`Shipping: ${shippingMethod} ${fmt(shippingAmount!,shippingCurrency||currency)}\n`:''}\nTotal: ${fmt(amount,currency)}\n\ncalcai.cc`;

  await fetch('https://api.resend.com/emails',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k}`},body:JSON.stringify({from:`${process.env.ORDER_FROM_NAME||'CalcAI'} <${process.env.ORDER_FROM_EMAIL||'orders@calcai.cc'}>`,to:[to],subject:`Order Confirmed #${orderId.slice(-8).toUpperCase()}`,html,text})});
}
