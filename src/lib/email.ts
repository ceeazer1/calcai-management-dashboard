interface OrderItem { description: string; quantity: number; amount: number; }
interface OrderConfirmationParams { to: string; customerName: string; orderId: string; amount: number; currency: string; items: OrderItem[]; paymentMethod?: string; shippingMethod?: string; shippingAmount?: number; shippingCurrency?: string; }

const esc = (s: string) => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const fmt = (a: number, c: string) => new Intl.NumberFormat('en-US',{style:'currency',currency:c.toUpperCase()}).format(a/100);

export async function sendOrderConfirmationEmail(p: OrderConfirmationParams): Promise<void> {
  const k = process.env.RESEND_API_KEY; if(!k) return;
  const {to,customerName,orderId,amount,currency,items,paymentMethod,shippingMethod,shippingAmount,shippingCurrency} = p;

  let rows = items.map(i=>`<tr><td style="padding:10px 0;border-bottom:1px solid #ddd;color:#222">${i.quantity}√ó ${esc(i.description)}</td><td style="padding:10px 0;border-bottom:1px solid #ddd;text-align:right;color:#555">${fmt(i.amount,currency)}</td></tr>`).join('');
  if(shippingMethod && shippingAmount) rows += `<tr><td style="padding:10px 0;border-bottom:1px solid #ddd;color:#222">Shipping ‚Äî ${esc(shippingMethod)}</td><td style="padding:10px 0;border-bottom:1px solid #ddd;text-align:right;color:#555">${fmt(shippingAmount,shippingCurrency||currency)}</td></tr>`;

  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><meta name="color-scheme" content="light dark"><style>@media(prefers-color-scheme:dark){.b{background:#111!important}.c{background:#1a1a1a!important}.t{color:#eee!important}.s{color:#aaa!important}.x{background:#222!important;border-color:#444!important}}</style></head><body style="margin:0;padding:0;font-family:system-ui,sans-serif"><table width="100%" cellpadding="0" cellspacing="0" class="b" bgcolor="#f5f5f5"><tr><td align="center" style="padding:20px 10px"><table width="560" cellpadding="0" cellspacing="0" class="c" bgcolor="#fff" style="max-width:560px;width:100%;border-radius:12px"><tr><td style="padding:20px"><img src="https://www.calcai.cc/logo.png" width="80" style="display:block;margin:0 auto 12px"><h1 class="t" style="margin:0 0 16px;text-align:center;color:#111;font-size:24px">Order Confirmed</h1><table width="100%" cellpadding="0" cellspacing="0" class="x" style="background:#f9f9f9;border:1px solid #e5e5e5;border-radius:8px;margin-bottom:16px"><tr><td style="padding:12px"><table width="100%" cellpadding="0" cellspacing="0"><tr><td width="40" align="center" valign="middle"><div style="width:24px;height:24px;background:#22c55e;border-radius:50%;color:#fff;font-size:12px;line-height:24px;text-align:center">‚úì</div></td><td valign="middle"><div style="height:2px;background:linear-gradient(90deg,#22c55e,#ccc)"></div></td><td width="40" align="center" valign="middle"><div class="x" style="width:24px;height:24px;background:#eee;border:1px solid #ccc;border-radius:50%;font-size:10px;line-height:22px;text-align:center">‚öô</div></td><td valign="middle"><div style="height:2px;background:#ccc"></div></td><td width="40" align="center" valign="middle"><div class="x" style="width:24px;height:24px;background:#eee;border:1px solid #ccc;border-radius:50%;font-size:10px;line-height:22px;text-align:center">üì¶</div></td><td valign="middle"><div style="height:2px;background:#ccc"></div></td><td width="40" align="center" valign="middle"><div class="x" style="width:24px;height:24px;background:#eee;border:1px solid #ccc;border-radius:50%;font-size:10px;line-height:22px;text-align:center">üè†</div></td></tr><tr><td align="center" style="padding-top:4px;color:#22c55e;font-size:9px;font-weight:700">Placed</td><td></td><td align="center" class="s" style="padding-top:4px;color:#888;font-size:9px">Process</td><td></td><td align="center" class="s" style="padding-top:4px;color:#888;font-size:9px">Shipped</td><td></td><td align="center" class="s" style="padding-top:4px;color:#888;font-size:9px">Delivered</td></tr></table></td></tr></table><p class="t" style="margin:0 0 8px;color:#111;font-size:16px;font-weight:600">Hi ${esc(customerName)},</p><p class="s" style="margin:0 0 14px;color:#555;font-size:14px">Thank you for your order. We will start processing in 1-2 days.</p><div class="x" style="background:#f9f9f9;border:1px solid #e5e5e5;border-radius:6px;padding:10px;margin-bottom:14px"><div class="s" style="color:#888;font-size:10px;text-transform:uppercase">Order ID</div><div class="t" style="color:#111;font-size:13px;font-family:monospace;margin-top:2px">${esc(orderId)}</div></div>${paymentMethod?`<p class="s" style="margin:0 0 14px;color:#555;font-size:13px"><b class="t" style="color:#111">Payment:</b> ${esc(paymentMethod)}</p>`:''}<table width="100%" cellpadding="0" cellspacing="0"><tr style="border-bottom:1px solid #ddd"><th align="left" class="s" style="padding:8px 0;color:#888;font-size:10px;text-transform:uppercase">Item</th><th align="right" class="s" style="padding:8px 0;color:#888;font-size:10px;text-transform:uppercase">Amount</th></tr>${rows}<tr style="border-top:1px solid #ddd"><td class="t" style="padding:12px 0;font-weight:700;color:#111">Total</td><td align="right" class="t" style="padding:12px 0;font-weight:700;color:#111;font-size:18px">${fmt(amount,currency)}</td></tr></table><div style="border-top:1px solid #e5e5e5;padding-top:14px;margin-top:10px;text-align:center"><a href="https://discord.gg/calcai" style="display:inline-block;margin:0 3px"><div class="x" style="width:28px;height:28px;background:#f0f0f0;border:1px solid #ddd;border-radius:50%;line-height:28px;font-size:12px">üí¨</div></a><a href="https://tiktok.com/@calc_ai" style="display:inline-block;margin:0 3px"><div class="x" style="width:28px;height:28px;background:#f0f0f0;border:1px solid #ddd;border-radius:50%;line-height:28px;font-size:12px">üéµ</div></a><a href="https://instagram.com/calc.ai" style="display:inline-block;margin:0 3px"><div class="x" style="width:28px;height:28px;background:#f0f0f0;border:1px solid #ddd;border-radius:50%;line-height:28px;font-size:12px">üì∑</div></a><p class="s" style="margin:10px 0 0;color:#aaa;font-size:10px"><a href="https://calcai.cc" style="color:#aaa;text-decoration:none">calcai.cc</a> ¬∑ ${new Date().getFullYear()} CalcAI</p></div></td></tr></table></td></tr></table></body></html>`;

  const text = `Order Confirmed\n\nHi ${customerName},\n\nThank you. Order ID: ${orderId}\n${paymentMethod?`Payment: ${paymentMethod}\n`:''}\n${items.map(i=>`${i.quantity}x ${i.description}: ${fmt(i.amount,currency)}`).join('\n')}\n${shippingMethod?`Shipping: ${shippingMethod} ${fmt(shippingAmount!,shippingCurrency||currency)}\n`:''}\nTotal: ${fmt(amount,currency)}\n\ncalcai.cc`;

  await fetch('https://api.resend.com/emails',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k}`},body:JSON.stringify({from:`${process.env.ORDER_FROM_NAME||'CalcAI'} <${process.env.ORDER_FROM_EMAIL||'orders@calcai.cc'}>`,to:[to],subject:`Order Confirmed #${orderId.slice(-8).toUpperCase()}`,html,text})});
}
