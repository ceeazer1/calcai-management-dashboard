<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CalcAI â€“ Device Activity</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="include.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  </style>
      <style>
        .device-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; }
        .device-card { background:#0b0f1a; border:1px solid var(--border-color); border-radius:10px; padding:12px; display:flex; flex-direction:column; gap:8px; }
        .device-card h3 { margin:0; font-size:14px; color:#e5e7eb; letter-spacing:0.2px; }
        .device-meta { color:#9fb3c8; font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .device-actions { display:flex; gap:8px; }
        /* Slimmer buttons just for this page */
        .device-actions .btn { padding:6px 10px; border-radius:8px; font-size:.9rem; box-shadow:0 4px 10px rgba(30,136,229,0.20); }
        .btn-outline { background:transparent; border:1px solid var(--border-color); color:#d1d5db; padding:6px 10px; border-radius:8px; box-shadow:none; }
        .hidden { display:none; }
      </style>

</head>
<body>
  <div data-include="/admin/_sidebar.html"></div>
  <div class="content" style="margin-left:240px; min-height:100vh;">
    <div class="header">
      <div class="header-left"><h1>Device Activity</h1></div>
      <div class="header-right"><a class="btn" href="/admin">Dashboard</a></div>
    </div>

    <div class="container">
      <div class="section">
        <div class="toolbar" style="justify-content: space-between;">
          <div>
            <h2 style="margin:6px 0 12px 0;">Devices</h2>
          </div>
          <div>
            <button id="refreshBtn" class="btn">Refresh</button>
          </div>
        </div>
        <div id="devicesGrid" class="device-grid"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (window.CALCAI_API_BASE && String(window.CALCAI_API_BASE)) || "https://calcai-server.fly.dev";
    let liveTimer = null;
    const DASH_BASE = ""; // same-origin dashboard API


    function macPretty(id){
      if(!id) return '';
      const s = String(id).toLowerCase();
      if(/^[0-9a-f]{12}$/.test(s)) return s.match(/.{1,2}/g).join(':');
      return s;
    }

    async function loadDevices(){
      const r = await fetch(`${API_BASE}/api/logs/device-activity/list`);
      if(!r.ok) throw new Error('failed to fetch device list');
      const data = await r.json();
      const ids = Array.isArray(data.deviceIds) ? data.deviceIds : [];

      // render device cards
      const grid = document.getElementById('devicesGrid');
      grid.innerHTML = ids.length ? '' : '<div class="device-meta">No devices yet</div>';
      ids.forEach(id=>{
        const pretty = macPretty(id);
        const card = document.createElement('div');
        card.className = 'device-card';
        card.innerHTML = `
          <h3>${pretty}</h3>
          <div class="device-meta">ID: ${id}</div>
          <div class="device-actions">
            <a class="btn" href="/admin/device.html?id=${id}">More info</a>
            <a class="btn btn-outline" href="${API_BASE}/api/logs/image/latest/${id}.jpg" target="_blank">View image</a>
            <button class="btn btn-outline" data-action="unlink" data-id="${id}">Unlink Device</button>
          </div>
        `;
        card.querySelector('[data-action="unlink"]').addEventListener('click', async ()=>{
          if(!confirm(`Unlink ${pretty}? This rotates code and clears notes.`)) return;
          try{
            const resp = await fetch(`${DASH_BASE}/api/pair/reset/${encodeURIComponent(id)}`, { method:'POST' });
            const json = await resp.json().catch(()=>({}));
            if(resp.ok && json.ok){
              alert('Device unlinked.');
            } else {
              alert('Failed to unlink.');
            }
          }catch(e){ alert('Failed to unlink'); }
        });
        grid.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadDevices();
      document.getElementById('refreshBtn').addEventListener('click', loadDevices);
    });
  </script>
</body>
</html>

