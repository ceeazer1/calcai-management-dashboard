<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device â€“ CalcAI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="include.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .code-box { background:#0b0f1a; border:1px solid var(--border-color); border-radius:10px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#e5e7eb; }
    .section-card { background:#0b0f1a; border:1px solid var(--border-color); border-radius:10px; padding:12px; }
    .logs-view { max-height: 45vh; overflow:auto; }
    .log-item { border-bottom:1px dashed rgba(255,255,255,0.08); padding:8px 0; }
    .log-meta { color:#9fb3c8; font-size:12px; margin-bottom:4px; display:flex; gap:8px; align-items:center; }
    .chip { display:inline-block; padding:2px 6px; border-radius:999px; background: rgba(30, 136, 229, 0.15); border:1px solid rgba(30, 136, 229, 0.35); color:#bbdefb; font-size:11px; }
    .type-text { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.35); color:#bbf7d0; }
    .type-image { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.35); color:#c7d2fe; }
  </style>
</head>
<body>
  <div data-include="/admin/_sidebar.html"></div>
  <div class="content" style="margin-left:240px; min-height:100vh;">
    <div class="header">
      <div class="header-left"><h1>Device</h1></div>
      <div class="header-right"><a class="btn" href="/admin/device-activity.html">Back to Devices</a></div>
    </div>

    <div class="container">
      <div class="section">
        <h2 id="deviceTitle">Loading...</h2>
        <div class="flex" style="gap:8px; margin-top:6px;">
          <button id="unlinkBtn" class="btn btn-outline">Unlink Device</button>
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
      </div>

      <div class="section">
        <h3>Pairing Code</h3>
        <div id="pairCode" class="code-box">Loading...</div>
      </div>

      <div class="section">
        <h3>Notes</h3>
        <div class="section-card">
          <pre id="notesBox" style="white-space: pre-wrap; margin:0; color:#d1d5db;">Loading...</pre>
        </div>
      </div>

      <div class="section">
        <h3>Prompt Logs</h3>
        <div id="logsView" class="section-card logs-view"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (window.CALCAI_API_BASE && String(window.CALCAI_API_BASE)) || "https://calcai-server.fly.dev";
    const DASH_BASE = ""; // same-origin

    function macPretty(id){
      if(!id) return ''; const s = String(id).toLowerCase();
      if(/^[0-9a-f]{12}$/.test(s)) return s.match(/.{1,2}/g).join(':');
      return s;
    }

    function getId(){
      const u = new URL(location.href);
      const id = (u.searchParams.get('id') || '').toLowerCase().replace(/[^0-9a-f]/g, '');
      return id && id.length === 12 ? id : '';
    }

    async function loadPairCode(id){
      const r = await fetch(`${DASH_BASE}/api/pair/code/${encodeURIComponent(id)}`);
      const j = await r.json().catch(()=>({}));
      if(j && j.ok && j.code){
        document.getElementById('pairCode').textContent = j.code;
      } else {
        document.getElementById('pairCode').textContent = 'N/A';
      }
    }

    async function loadNotes(id){
      const r = await fetch(`${DASH_BASE}/api/notes-admin/${encodeURIComponent(id)}`);
      const j = await r.json().catch(()=>({}));
      if(j && j.ok){
        document.getElementById('notesBox').textContent = j.text || '';
      } else {
        document.getElementById('notesBox').textContent = 'Failed to load notes';
      }
    }

    async function fetchLogs(id){
      const r = await fetch(`${API_BASE}/api/logs/device-activity/logs/${encodeURIComponent(id)}?limit=300`);
      if(!r.ok) return [];
      const j = await r.json().catch(()=>({}));
      return Array.isArray(j.logs) ? j.logs : [];
    }

    function renderLogs(list){
      const el = document.getElementById('logsView');
      if(list.length===0){ el.innerHTML = '<div class="log-item"><div class="log-meta">No activity yet.</div></div>'; return; }
      el.innerHTML = list.map(e=>{
        const t = new Date(e.ts||Date.now()).toLocaleString();
        const type = (e.type||'text');
        const chips = `<span class=\"chip ${type==='image'?'type-image':'type-text'}\">${type.toUpperCase()}</span>`;
        const prompt = e.prompt || e.question || '';
        const resp = e.response || '';
        return `<div class=\"log-item\"><div class=\"log-meta\"><span>${t}</span> ${chips}</div>${prompt?`<div><strong>Prompt:</strong> ${prompt}</div>`:''}${resp?`<div><strong>Response:</strong> ${resp}</div>`:''}</div>`;
      }).join('');
    }

    async function refreshAll(){
      const id = getId(); if(!id) return;
      document.getElementById('deviceTitle').textContent = `Device ${macPretty(id)}`;
      await Promise.all([
        loadPairCode(id),
        loadNotes(id),
        fetchLogs(id).then(renderLogs)
      ]);
    }

    async function unlinkDevice(){
      const id = getId(); if(!id) return;
      if(!confirm(`Unlink ${macPretty(id)}? This rotates the code and clears notes.`)) return;
      try{
        const r = await fetch(`${DASH_BASE}/api/pair/reset/${encodeURIComponent(id)}`, { method:'POST' });
        const j = await r.json().catch(()=>({}));
        if(j && j.ok){
          alert('Device unlinked. New code issued.');
          refreshAll();
        } else {
          alert('Failed to unlink.');
        }
      }catch(e){ alert('Error'); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('unlinkBtn').addEventListener('click', unlinkDevice);
      document.getElementById('refreshBtn').addEventListener('click', refreshAll);
      refreshAll();
    });
  </script>
</body>
</html>

